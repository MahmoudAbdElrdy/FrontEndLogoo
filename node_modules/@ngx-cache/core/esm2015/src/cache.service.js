import { Inject, Injectable, InjectionToken, Injector, PLATFORM_ID } from '@angular/core';
import { CacheLoader } from './cache.loader';
import { ReturnType } from './models/return-type';
export const CACHE = new InjectionToken('CACHE');
export class CacheService {
    constructor(loader, platformId, injector) {
        this.loader = loader;
        this.platformId = platformId;
        this.injector = injector;
        CacheService.instance = this;
        this.cache = this.injector.get(CACHE);
        this.lifeSpan = loader.lifeSpan;
    }
    static getInstance(loader, platformId, injector) {
        return CacheService.instance;
    }
    static normalizeKey(key) {
        if (CacheService.validateKey(key)) {
            throw new Error('Please provide a valid key to save in the CacheService');
        }
        return `${key}`;
    }
    static validateKey(key) {
        return !key || typeof key === 'boolean' || Number.isNaN(key);
    }
    static validateValue(value) {
        return value.lifeSpan.expiry && value.lifeSpan.expiry > Date.now();
    }
    get key() {
        return this.loader.key;
    }
    has(key) {
        const normalized = CacheService.normalizeKey(key);
        return this.cache.keys.indexOf(normalized) !== -1;
    }
    set(key, value, returnType = ReturnType.Scalar, lifeSpan) {
        const normalized = CacheService.normalizeKey(key);
        return this.cache.setItem(normalized, {
            data: value,
            returnType,
            lifeSpan: this.parseLifeSpan(lifeSpan ? lifeSpan : this.lifeSpan)
        });
    }
    get(key) {
        const normalized = CacheService.normalizeKey(key);
        const cached = this.cache.getItem(normalized);
        if (cached) {
            if (CacheService.validateValue(cached)) {
                return cached.data;
            }
            else {
                this.remove(normalized);
            }
        }
        return undefined;
    }
    getWithMetadata(key) {
        const normalized = CacheService.normalizeKey(key);
        const cached = this.cache.getItem(normalized);
        if (cached) {
            if (CacheService.validateValue(cached)) {
                return cached;
            }
            else {
                this.remove(key);
            }
        }
        return undefined;
    }
    remove(key, wild = false) {
        const normalized = CacheService.normalizeKey(key);
        this.cache.removeItem(normalized, wild);
    }
    clear() {
        this.cache.clear();
    }
    dehydrate() {
        const keys = this.cache.keys.length ? this.cache.keys : [];
        const res = {};
        keys.forEach((key) => {
            res[key] = this.cache.getItem(key);
        });
        return res;
    }
    rehydrate(json) {
        Object.keys(json).forEach((key) => {
            const normalized = CacheService.normalizeKey(key);
            this.cache.setItem(normalized, json[normalized]);
        });
    }
    parseLifeSpan(lifeSpan) {
        return {
            expiry: lifeSpan.expiry || (lifeSpan.TTL ? Date.now() + lifeSpan.TTL * 1000 : this.lifeSpan.expiry),
            TTL: lifeSpan.TTL || this.lifeSpan.TTL
        };
    }
}
CacheService.instance = undefined;
CacheService.decorators = [
    { type: Injectable }
];
CacheService.ctorParameters = () => [
    { type: CacheLoader },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtY2FjaGUvY29yZS8iLCJzb3VyY2VzIjpbInNyYy9jYWNoZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzFGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbEQsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUFHLElBQUksY0FBYyxDQUFRLE9BQU8sQ0FBQyxDQUFDO0FBR3hELE1BQU0sT0FBTyxZQUFZO0lBMEJ2QixZQUFxQixNQUFtQixFQUF3QyxVQUFlLEVBQW1CLFFBQWtCO1FBQS9HLFdBQU0sR0FBTixNQUFNLENBQWE7UUFBd0MsZUFBVSxHQUFWLFVBQVUsQ0FBSztRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xJLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBRTdCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUF6QkQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFvQixFQUFFLFVBQWdCLEVBQUUsUUFBbUI7UUFDNUUsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQW9CO1FBQ3RDLElBQUksWUFBWSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7U0FDM0U7UUFFRCxPQUFPLEdB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USIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgQ2FjaGUgfSBmcm9tICcuL2NhY2hlJztcclxuaW1wb3J0IHsgQ2FjaGVMb2FkZXIgfSBmcm9tICcuL2NhY2hlLmxvYWRlcic7XHJcbmltcG9ydCB7IENhY2hlVmFsdWUgfSBmcm9tICcuL21vZGVscy9jYWNoZS12YWx1ZSc7XHJcbmltcG9ydCB7IExpZmVTcGFuIH0gZnJvbSAnLi9tb2RlbHMvbGlmZS1zcGFuJztcclxuaW1wb3J0IHsgUmV0dXJuVHlwZSB9IGZyb20gJy4vbW9kZWxzL3JldHVybi10eXBlJztcclxuXHJcbmV4cG9ydCBjb25zdCBDQUNIRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDYWNoZT4oJ0NBQ0hFJyk7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDYWNoZVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBDYWNoZVNlcnZpY2UgPSB1bmRlZmluZWQ7XHJcblxyXG4gIHByb3RlY3RlZCByZWFkb25seSBjYWNoZTogQ2FjaGU7XHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGxpZmVTcGFuOiBMaWZlU3BhbjtcclxuXHJcbiAgc3RhdGljIGdldEluc3RhbmNlKGxvYWRlcj86IENhY2hlTG9hZGVyLCBwbGF0Zm9ybUlkPzogYW55LCBpbmplY3Rvcj86IEluamVjdG9yKTogQ2FjaGVTZXJ2aWNlIHtcclxuICAgIHJldHVybiBDYWNoZVNlcnZpY2UuaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgbm9ybWFsaXplS2V5KGtleTogc3RyaW5nIHwgbnVtYmVyKTogc3RyaW5nIHtcclxuICAgIGlmIChDYWNoZVNlcnZpY2UudmFsaWRhdGVLZXkoa2V5KSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQga2V5IHRvIHNhdmUgaW4gdGhlIENhY2hlU2VydmljZScpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBgJHtrZXl9YDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIHZhbGlkYXRlS2V5KGtleTogc3RyaW5nIHwgbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gIWtleSB8fCB0eXBlb2Yga2V5ID09PSAnYm9vbGVhbicgfHwgTnVtYmVyLmlzTmFOKGtleSBhcyBudW1iZXIpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgdmFsaWRhdGVWYWx1ZSh2YWx1ZTogQ2FjaGVWYWx1ZSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHZhbHVlLmxpZmVTcGFuLmV4cGlyeSAmJiB2YWx1ZS5saWZlU3Bhbi5leHBpcnkgPiBEYXRlLm5vdygpO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbG9hZGVyOiBDYWNoZUxvYWRlciwgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSByZWFkb25seSBwbGF0Zm9ybUlkOiBhbnksIHByaXZhdGUgcmVhZG9ubHkgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICBDYWNoZVNlcnZpY2UuaW5zdGFuY2UgPSB0aGlzO1xyXG5cclxuICAgIHRoaXMuY2FjaGUgPSB0aGlzLmluamVjdG9yLmdldChDQUNIRSk7XHJcbiAgICB0aGlzLmxpZmVTcGFuID0gbG9hZGVyLmxpZmVTcGFuO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGtleSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMubG9hZGVyLmtleTtcclxuICB9XHJcblxyXG4gIGhhcyhrZXk6IHN0cmluZyB8IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5rZXlzLmluZGV4T2Yobm9ybWFsaXplZCkgIT09IC0xO1xyXG4gIH1cclxuXHJcbiAgc2V0KGtleTogc3RyaW5nIHwgbnVtYmVyLCB2YWx1ZTogYW55LCByZXR1cm5UeXBlOiBSZXR1cm5UeXBlID0gUmV0dXJuVHlwZS5TY2FsYXIsIGxpZmVTcGFuPzogTGlmZVNwYW4pOiBib29sZWFuIHtcclxuICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBDYWNoZVNlcnZpY2Uubm9ybWFsaXplS2V5KGtleSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuc2V0SXRlbShub3JtYWxpemVkLCB7XHJcbiAgICAgIGRhdGE6IHZhbHVlLFxyXG4gICAgICByZXR1cm5UeXBlLFxyXG4gICAgICBsaWZlU3BhbjogdGhpcy5wYXJzZUxpZmVTcGFuKGxpZmVTcGFuID8gbGlmZVNwYW4gOiB0aGlzLmxpZmVTcGFuKVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXQoa2V5OiBzdHJpbmcgfCBudW1iZXIpOiBhbnkge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcclxuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0SXRlbShub3JtYWxpemVkKTtcclxuXHJcbiAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgIGlmIChDYWNoZVNlcnZpY2UudmFsaWRhdGVWYWx1ZShjYWNoZWQpKSB7XHJcbiAgICAgICAgcmV0dXJuIGNhY2hlZC5kYXRhO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlKG5vcm1hbGl6ZWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIGdldFdpdGhNZXRhZGF0YShrZXk6IHN0cmluZyB8IG51bWJlcik6IENhY2hlVmFsdWUgfCB1bmRlZmluZWQge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcclxuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0SXRlbShub3JtYWxpemVkKTtcclxuXHJcbiAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgIGlmIChDYWNoZVNlcnZpY2UudmFsaWRhdGVWYWx1ZShjYWNoZWQpKSB7XHJcbiAgICAgICAgcmV0dXJuIGNhY2hlZDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnJlbW92ZShrZXkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIHJlbW92ZShrZXk6IHN0cmluZyB8IG51bWJlciwgd2lsZCA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xyXG5cclxuICAgIHRoaXMuY2FjaGUucmVtb3ZlSXRlbShub3JtYWxpemVkLCB3aWxkKTtcclxuICB9XHJcblxyXG4gIGNsZWFyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jYWNoZS5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgZGVoeWRyYXRlKCk6IGFueSB7XHJcbiAgICBjb25zdCBrZXlzID0gdGhpcy5jYWNoZS5rZXlzLmxlbmd0aCA/IHRoaXMuY2FjaGUua2V5cyA6IFtdO1xyXG4gICAgY29uc3QgcmVzID0ge307XHJcblxyXG4gICAga2V5cy5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXNba2V5XSA9IHRoaXMuY2FjaGUuZ2V0SXRlbShrZXkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHJlcztcclxuICB9XHJcblxyXG4gIHJlaHlkcmF0ZShqc29uOiBhbnkpOiB2b2lkIHtcclxuICAgIE9iamVjdC5rZXlzKGpzb24pLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBDYWNoZVNlcnZpY2Uubm9ybWFsaXplS2V5KGtleSk7XHJcbiAgICAgIHRoaXMuY2FjaGUuc2V0SXRlbShub3JtYWxpemVkLCBqc29uW25vcm1hbGl6ZWRdKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZUxpZmVTcGFuKGxpZmVTcGFuOiBMaWZlU3Bhbik6IExpZmVTcGFuIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGV4cGlyeTogbGlmZVNwYW4uZXhwaXJ5IHx8IChsaWZlU3Bhbi5UVEwgPyBEYXRlLm5vdygpICsgbGlmZVNwYW4uVFRMICogMTAwMCA6IHRoaXMubGlmZVNwYW4uZXhwaXJ5KSxcclxuICAgICAgVFRMOiBsaWZlU3Bhbi5UVEwgfHwgdGhpcy5saWZlU3Bhbi5UVExcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==