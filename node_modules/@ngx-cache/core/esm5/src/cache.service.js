import { Inject, Injectable, InjectionToken, Injector, PLATFORM_ID } from '@angular/core';
import { CacheLoader } from './cache.loader';
import { ReturnType } from './models/return-type';
export var CACHE = new InjectionToken('CACHE');
var CacheService = (function () {
    function CacheService(loader, platformId, injector) {
        this.loader = loader;
        this.platformId = platformId;
        this.injector = injector;
        CacheService.instance = this;
        this.cache = this.injector.get(CACHE);
        this.lifeSpan = loader.lifeSpan;
    }
    CacheService.getInstance = function (loader, platformId, injector) {
        return CacheService.instance;
    };
    CacheService.normalizeKey = function (key) {
        if (CacheService.validateKey(key)) {
            throw new Error('Please provide a valid key to save in the CacheService');
        }
        return "" + key;
    };
    CacheService.validateKey = function (key) {
        return !key || typeof key === 'boolean' || Number.isNaN(key);
    };
    CacheService.validateValue = function (value) {
        return value.lifeSpan.expiry && value.lifeSpan.expiry > Date.now();
    };
    Object.defineProperty(CacheService.prototype, "key", {
        get: function () {
            return this.loader.key;
        },
        enumerable: true,
        configurable: true
    });
    CacheService.prototype.has = function (key) {
        var normalized = CacheService.normalizeKey(key);
        return this.cache.keys.indexOf(normalized) !== -1;
    };
    CacheService.prototype.set = function (key, value, returnType, lifeSpan) {
        if (returnType === void 0) { returnType = ReturnType.Scalar; }
        var normalized = CacheService.normalizeKey(key);
        return this.cache.setItem(normalized, {
            data: value,
            returnType: returnType,
            lifeSpan: this.parseLifeSpan(lifeSpan ? lifeSpan : this.lifeSpan)
        });
    };
    CacheService.prototype.get = function (key) {
        var normalized = CacheService.normalizeKey(key);
        var cached = this.cache.getItem(normalized);
        if (cached) {
            if (CacheService.validateValue(cached)) {
                return cached.data;
            }
            else {
                this.remove(normalized);
            }
        }
        return undefined;
    };
    CacheService.prototype.getWithMetadata = function (key) {
        var normalized = CacheService.normalizeKey(key);
        var cached = this.cache.getItem(normalized);
        if (cached) {
            if (CacheService.validateValue(cached)) {
                return cached;
            }
            else {
                this.remove(key);
            }
        }
        return undefined;
    };
    CacheService.prototype.remove = function (key, wild) {
        if (wild === void 0) { wild = false; }
        var normalized = CacheService.normalizeKey(key);
        this.cache.removeItem(normalized, wild);
    };
    CacheService.prototype.clear = function () {
        this.cache.clear();
    };
    CacheService.prototype.dehydrate = function () {
        var _this = this;
        var keys = this.cache.keys.length ? this.cache.keys : [];
        var res = {};
        keys.forEach(function (key) {
            res[key] = _this.cache.getItem(key);
        });
        return res;
    };
    CacheService.prototype.rehydrate = function (json) {
        var _this = this;
        Object.keys(json).forEach(function (key) {
            var normalized = CacheService.normalizeKey(key);
            _this.cache.setItem(normalized, json[normalized]);
        });
    };
    CacheService.prototype.parseLifeSpan = function (lifeSpan) {
        return {
            expiry: lifeSpan.expiry || (lifeSpan.TTL ? Date.now() + lifeSpan.TTL * 1000 : this.lifeSpan.expiry),
            TTL: lifeSpan.TTL || this.lifeSpan.TTL
        };
    };
    CacheService.instance = undefined;
    CacheService.decorators = [
        { type: Injectable }
    ];
    CacheService.ctorParameters = function () { return [
        { type: CacheLoader },
        { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
        { type: Injector }
    ]; };
    return CacheService;
}());
export { CacheService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtY2FjaGUvY29yZS8iLCJzb3VyY2VzIjpbInNyYy9jYWNoZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzFGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbEQsTUFBTSxDQUFDLElBQU0sS0FBSyxHQUFHLElBQUksY0FBYyxDQUFRLE9BQU8sQ0FBQyxDQUFDO0FBRXhEO0lBMkJFLHNCQUFxQixNQUFtQixFQUF3QyxVQUFlLEVBQW1CLFFBQWtCO1FBQS9HLFdBQU0sR0FBTixNQUFNLENBQWE7UUFBd0MsZUFBVSxHQUFWLFVBQVUsQ0FBSztRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xJLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBRTdCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUF6Qk0sd0JBQVcsR0FBbEIsVUFBbUIsTUFBb0IsRUFBRSxVQUFnQixFQUFFLFFBQW1CO1FBQzVFLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRU0seUJBQVksR0FBbkIsVUFBb0IsR0FBb0I7UUFDdEMsSUFBSSxZQUFZLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztTQUMzRTtRQUVELE9BQU8sS0FBRyxHQUFLLENBQUM7SUFDbEIs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bkhjLHFCQUFRLEdBQWlCLFNBQVMsQ0FBQzs7Z0JBRm5ELFVBQVU7OztnQkFQRixXQUFXO2dEQWtDeUIsTUFBTSxTQUFDLFdBQVc7Z0JBckNsQixRQUFROztJQWdJckQsbUJBQUM7Q0FBQSxBQXRIRCxJQXNIQztTQXJIWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0b3IsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBDYWNoZSB9IGZyb20gJy4vY2FjaGUnO1xyXG5pbXBvcnQgeyBDYWNoZUxvYWRlciB9IGZyb20gJy4vY2FjaGUubG9hZGVyJztcclxuaW1wb3J0IHsgQ2FjaGVWYWx1ZSB9IGZyb20gJy4vbW9kZWxzL2NhY2hlLXZhbHVlJztcclxuaW1wb3J0IHsgTGlmZVNwYW4gfSBmcm9tICcuL21vZGVscy9saWZlLXNwYW4nO1xyXG5pbXBvcnQgeyBSZXR1cm5UeXBlIH0gZnJvbSAnLi9tb2RlbHMvcmV0dXJuLXR5cGUnO1xyXG5cclxuZXhwb3J0IGNvbnN0IENBQ0hFID0gbmV3IEluamVjdGlvblRva2VuPENhY2hlPignQ0FDSEUnKTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENhY2hlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IENhY2hlU2VydmljZSA9IHVuZGVmaW5lZDtcclxuXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGNhY2hlOiBDYWNoZTtcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgbGlmZVNwYW46IExpZmVTcGFuO1xyXG5cclxuICBzdGF0aWMgZ2V0SW5zdGFuY2UobG9hZGVyPzogQ2FjaGVMb2FkZXIsIHBsYXRmb3JtSWQ/OiBhbnksIGluamVjdG9yPzogSW5qZWN0b3IpOiBDYWNoZVNlcnZpY2Uge1xyXG4gICAgcmV0dXJuIENhY2hlU2VydmljZS5pbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBub3JtYWxpemVLZXkoa2V5OiBzdHJpbmcgfCBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgaWYgKENhY2hlU2VydmljZS52YWxpZGF0ZUtleShrZXkpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignUGxlYXNlIHByb3ZpZGUgYSB2YWxpZCBrZXkgdG8gc2F2ZSBpbiB0aGUgQ2FjaGVTZXJ2aWNlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGAke2tleX1gO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgdmFsaWRhdGVLZXkoa2V5OiBzdHJpbmcgfCBudW1iZXIpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAha2V5IHx8IHR5cGVvZiBrZXkgPT09ICdib29sZWFuJyB8fCBOdW1iZXIuaXNOYU4oa2V5IGFzIG51bWJlcik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXRpYyB2YWxpZGF0ZVZhbHVlKHZhbHVlOiBDYWNoZVZhbHVlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdmFsdWUubGlmZVNwYW4uZXhwaXJ5ICYmIHZhbHVlLmxpZmVTcGFuLmV4cGlyeSA+IERhdGUubm93KCk7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBsb2FkZXI6IENhY2hlTG9hZGVyLCBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHJlYWRvbmx5IHBsYXRmb3JtSWQ6IGFueSwgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIENhY2hlU2VydmljZS5pbnN0YW5jZSA9IHRoaXM7XHJcblxyXG4gICAgdGhpcy5jYWNoZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KENBQ0hFKTtcclxuICAgIHRoaXMubGlmZVNwYW4gPSBsb2FkZXIubGlmZVNwYW47XHJcbiAgfVxyXG5cclxuICBnZXQga2V5KCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5sb2FkZXIua2V5O1xyXG4gIH1cclxuXHJcbiAgaGFzKGtleTogc3RyaW5nIHwgbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmNhY2hlLmtleXMuaW5kZXhPZihub3JtYWxpemVkKSAhPT0gLTE7XHJcbiAgfVxyXG5cclxuICBzZXQoa2V5OiBzdHJpbmcgfCBudW1iZXIsIHZhbHVlOiBhbnksIHJldHVyblR5cGU6IFJldHVyblR5cGUgPSBSZXR1cm5UeXBlLlNjYWxhciwgbGlmZVNwYW4/OiBMaWZlU3Bhbik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5zZXRJdGVtKG5vcm1hbGl6ZWQsIHtcclxuICAgICAgZGF0YTogdmFsdWUsXHJcbiAgICAgIHJldHVyblR5cGUsXHJcbiAgICAgIGxpZmVTcGFuOiB0aGlzLnBhcnNlTGlmZVNwYW4obGlmZVNwYW4gPyBsaWZlU3BhbiA6IHRoaXMubGlmZVNwYW4pXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldChrZXk6IHN0cmluZyB8IG51bWJlcik6IGFueSB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xyXG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXRJdGVtKG5vcm1hbGl6ZWQpO1xyXG5cclxuICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgaWYgKENhY2hlU2VydmljZS52YWxpZGF0ZVZhbHVlKGNhY2hlZCkpIHtcclxuICAgICAgICByZXR1cm4gY2FjaGVkLmRhdGE7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmUobm9ybWFsaXplZCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgZ2V0V2l0aE1ldGFkYXRhKGtleTogc3RyaW5nIHwgbnVtYmVyKTogQ2FjaGVWYWx1ZSB8IHVuZGVmaW5lZCB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkID0gQ2FjaGVTZXJ2aWNlLm5vcm1hbGl6ZUtleShrZXkpO1xyXG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXRJdGVtKG5vcm1hbGl6ZWQpO1xyXG5cclxuICAgIGlmIChjYWNoZWQpIHtcclxuICAgICAgaWYgKENhY2hlU2VydmljZS52YWxpZGF0ZVZhbHVlKGNhY2hlZCkpIHtcclxuICAgICAgICByZXR1cm4gY2FjaGVkO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlKGtleSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlKGtleTogc3RyaW5nIHwgbnVtYmVyLCB3aWxkID0gZmFsc2UpOiB2b2lkIHtcclxuICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBDYWNoZVNlcnZpY2Uubm9ybWFsaXplS2V5KGtleSk7XHJcblxyXG4gICAgdGhpcy5jYWNoZS5yZW1vdmVJdGVtKG5vcm1hbGl6ZWQsIHdpbGQpO1xyXG4gIH1cclxuXHJcbiAgY2xlYXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XHJcbiAgfVxyXG5cclxuICBkZWh5ZHJhdGUoKTogYW55IHtcclxuICAgIGNvbnN0IGtleXMgPSB0aGlzLmNhY2hlLmtleXMubGVuZ3RoID8gdGhpcy5jYWNoZS5rZXlzIDogW107XHJcbiAgICBjb25zdCByZXMgPSB7fTtcclxuXHJcbiAgICBrZXlzLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJlc1trZXldID0gdGhpcy5jYWNoZS5nZXRJdGVtKGtleSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgcmVoeWRyYXRlKGpzb246IGFueSk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmtleXMoanNvbikuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IENhY2hlU2VydmljZS5ub3JtYWxpemVLZXkoa2V5KTtcclxuICAgICAgdGhpcy5jYWNoZS5zZXRJdGVtKG5vcm1hbGl6ZWQsIGpzb25bbm9ybWFsaXplZF0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTGlmZVNwYW4obGlmZVNwYW46IExpZmVTcGFuKTogTGlmZVNwYW4ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgZXhwaXJ5OiBsaWZlU3Bhbi5leHBpcnkgfHwgKGxpZmVTcGFuLlRUTCA/IERhdGUubm93KCkgKyBsaWZlU3Bhbi5UVEwgKiAxMDAwIDogdGhpcy5saWZlU3Bhbi5leHBpcnkpLFxyXG4gICAgICBUVEw6IGxpZmVTcGFuLlRUTCB8fCB0aGlzLmxpZmVTcGFuLlRUTFxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl19